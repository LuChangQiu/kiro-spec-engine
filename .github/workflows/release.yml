name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: [16.x, 18.x, 20.x, 22.x]
        exclude:
          - os: macos-latest
            node-version: 16.x
          - os: macos-latest
            node-version: 18.x
          - os: macos-latest
            node-version: 20.x
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests
        run: npm test
      
      - name: Check coverage
        run: npm run coverage

  publish:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.x'
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Publish to npm
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Build release evidence notes
        id: release_notes
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          RELEASE_DATE="$(date -u +%F)"
          NOTES_DIR=".kiro/reports/release-evidence"
          EVIDENCE_FILE="${NOTES_DIR}/handoff-runs.json"
          REVIEW_FILE="${NOTES_DIR}/handoff-evidence-review-${TAG}.md"
          DRAFT_FILE="${NOTES_DIR}/release-notes-${TAG}.md"
          FALLBACK_FILE="${NOTES_DIR}/release-notes-fallback-${TAG}.md"
          SUMMARY_FILE="${NOTES_DIR}/release-evidence-summary-${TAG}.json"

          mkdir -p "${NOTES_DIR}"

          if [[ -f "${EVIDENCE_FILE}" ]]; then
            if node bin/kiro-spec-engine.js auto handoff evidence \
              --file "${EVIDENCE_FILE}" \
              --review-out "${REVIEW_FILE}" \
              --release-draft "${DRAFT_FILE}" \
              --release-version "${TAG}" \
              --release-date "${RELEASE_DATE}" \
              --json > "${SUMMARY_FILE}"; then
              if [[ -f "${DRAFT_FILE}" ]]; then
                echo "release_body_file=${DRAFT_FILE}" >> "$GITHUB_OUTPUT"
                {
                  echo "asset_files<<EOF"
                  echo "${DRAFT_FILE}"
                  if [[ -f "${REVIEW_FILE}" ]]; then
                    echo "${REVIEW_FILE}"
                  fi
                  if [[ -f "${SUMMARY_FILE}" ]]; then
                    echo "${SUMMARY_FILE}"
                  fi
                  echo "EOF"
                } >> "$GITHUB_OUTPUT"
                exit 0
              fi
            fi
          fi

          cat > "${FALLBACK_FILE}" <<EOF
          # Release ${TAG}

          Release date: ${RELEASE_DATE}

          See [CHANGELOG.md](https://github.com/${GITHUB_REPOSITORY}/blob/main/CHANGELOG.md) for details.
          EOF
          echo "release_body_file=${FALLBACK_FILE}" >> "$GITHUB_OUTPUT"
          {
            echo "asset_files<<EOF"
            echo "${FALLBACK_FILE}"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: ${{ steps.release_notes.outputs.release_body_file }}
          files: ${{ steps.release_notes.outputs.asset_files }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
